<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>بوابة التقارير</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f9f7; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#006C35; --line:#e0efe7; --accent:#009879; --radius:14px; }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0; padding:0; font-family:'Tajawal', system-ui, sans-serif; background:var(--bg); color:var(--ink) }
    header.site{ background:linear-gradient(180deg,#0f7a46 0%, #0a5b35 100%); color:#fff; position:relative }
    .hero{ inline-size:100%; block-size:clamp(120px, 16vw, 180px); background-position:center; background-repeat:no-repeat; background-size:cover }
    .page{ max-width:950px; margin:0 auto; padding:16px }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:24px; box-shadow:0 2px 8px rgba(0,0,0,0.05) }
    .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:16px }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }
    label{ font-size:14px; color:var(--muted); display:block; margin-bottom:6px; font-weight:700 }
    input[type="text"], input[type="date"], textarea{ width:100%; border:1px solid var(--line); border-radius:12px; padding:12px 14px; font-size:16px; background:#fff; outline:none; transition:border 0.2s }
    input:focus, textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 4px rgba(0,108,53,.15) }
    textarea{ min-height:120px; resize:vertical }
    .uploader-ctrl{ margin-top:20px }
    .uploader{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:8px }
    .slot{ border:2px dashed var(--line); border-radius:12px; aspect-ratio:4/3; position:relative; overflow:hidden; background:#f8fcf9; display:grid; place-items:center; cursor:pointer; transition:border 0.2s }
    .slot:hover{ border-color:var(--brand) }
    .slot input{ position:absolute; inset:0; opacity:0; cursor:pointer }
    .slot img{ width:100%; height:100%; object-fit:cover }
    .slot .remove{ position:absolute; top:8px; left:8px; background:#ef4444; color:#fff; border:none; border-radius:50%; width:32px; height:32px; cursor:pointer; font-size:18px; font-weight:bold; display:none; z-index:2 }
    .slot.has-img .remove{ display:block }
    .bar{ display:flex; gap:12px; flex-wrap:wrap; margin-top:16px; justify-content:flex-end }
    .btn{ padding:12px 20px; border-radius:12px; font-weight:800; cursor:pointer; transition:all 0.2s }
    .btn{ background:var(--brand); color:#fff; border:none }
    .btn.outline{ background:transparent; color:var(--brand); border:1px solid var(--brand) }
    .btn:hover{ opacity:0.9; transform:translateY(-1px) }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; transform:none }
    footer.site{ margin-top:40px; background:#0b3d28; color:#d7f5e4; padding:20px 0; text-align:center; font-weight:800 }
  </style>
</head>
<body>

  <header class="site">
    <div class="hero" id="site-hero"></div>
  </header>

  <main class="page">
    <section class="card">
      <h2 style="margin:0 0 20px; color:#064e2d; font-size:24px">بيانات التقرير </h2>
      
      <div class="grid">
        <div><label>اسم البرنامج</label><input type="text" id="program"></div>
        <div><label>المنفذ</label><input type="text" id="executor"></div>
        <div><label>المستهدفون</label><input type="text" id="audience"></div>
        <div><label>عدد المستفيدين</label><input type="text" id="beneficiaries"></div>
        <div><label>تاريخ التنفيذ</label><input type="date" id="execdate"></div>
        <div><label>مكان التنفيذ</label><input type="text" id="venue"></div>
        <div><label>مدير المدرسة</label><input type="text" id="principal" placeholder="اسم مدير المدرسة"></div>
      </div>

      <div style="margin-top:16px">
        <label>الأهداف</label>
        <textarea id="goals" placeholder="اكتب كل هدف في سطر منفصل..."></textarea>
      </div>

      <div class="uploader-ctrl">
        <label>الشواهد والصور <span id="w-count" style="color:var(--muted)">(0/4)</span></label>
        <div class="uploader" id="uploader"></div>
        
        <div class="bar">
          <button class="btn outline" id="clearImages" type="button">حذف الكل</button>
          <button class="btn outline" id="addImage" type="button">إضافة صورة</button>
          <button class="btn" id="exportPdfBtn" type="button">تصدير كـ PDF</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="site">
    <div>تصميم وتطوير: أ/ نفال النفيعي</div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $ = s => document.querySelector(s);
      const $$ = s => document.querySelectorAll(s);

      const program = $('#program');
      const executor = $('#executor');
      const audience = $('#audience');
      const beneficiaries = $('#beneficiaries');
      const execdate = $('#execdate');
      const venue = $('#venue');
      const principal = $('#principal');
      const goals = $('#goals');
      const uploader = $('#uploader');
      const countEl = $('#w-count');
      const addBtn = $('#addImage');
      const clearBtn = $('#clearImages');
      const exportBtn = $('#exportPdfBtn');
      const hero = $('#site-hero');

      const STORAGE_KEY = 'school_report_images_v3'; // مفتاح عام
      const MAX_IMAGES = 4;

      // تحميل خلفية الهيدر
      (function initHero() {
        const qp = new URLSearchParams(location.search).get('dibajah');
        if (qp) {
          hero.style.backgroundImage = `url('${qp}')`;
        } else {
          const fallback = () => hero.style.background = 'linear-gradient(135deg, #0f7a46, #099169)';
          const img = new Image();
          img.onload = () => hero.style.backgroundImage = `url('${img.src}')`;
          img.onerror = fallback;
          img.src = '26.webp'; // أو 26.png حسب ما لديك
        }
      })();

      // إنشاء slot
      function createSlot(src = null) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        if (src) slot.classList.add('has-img');

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';

        const img = document.createElement('img');
        if (src) img.src = src;

        const remove = document.createElement('button');
        remove.className = 'remove';
        remove.innerHTML = '×';
        remove.type = 'button';
        remove.onclick = (e) => {
          e.stopPropagation();
          slot.remove();
          saveImages();
          ensureEmptySlot();
          updateCounter();
        };

        input.onchange = e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            img.src = ev.target.result;
            slot.classList.add('has-img');
            if (!slot.contains(img)) slot.appendChild(img);
            saveImages();
            ensureEmptySlot();
            updateCounter();
          };
          reader.readAsDataURL(file);
        };

        slot.appendChild(remove);
        slot.appendChild(input);
        if (src) slot.appendChild(img);
        else slot.innerHTML += '<small style="color:#64748b; pointer-events:none">اضغط لإضافة صورة</small>';

        slot.onclick = () => input.click();
        return slot;
      }

      function saveImages() {
        const images = [...uploader.querySelectorAll('img')].map(img => img.src);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(images.slice(0, MAX_IMAGES)));
      }

      function loadImages() {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        uploader.innerHTML = '';
        saved.forEach(src => uploader.appendChild(createSlot(src)));
        ensureEmptySlot();
        updateCounter();
      }

      function ensureEmptySlot() {
        const filled = uploader.querySelectorAll('img').length;
        const hasEmpty = [...uploader.children].some(s => !s.querySelector('img'));
        if (filled < MAX_IMAGES && !hasEmpty) {
          uploader.appendChild(createSlot());
        }
        addBtn.disabled = filled >= MAX_IMAGES;
      }

      function updateCounter() {
        const count = uploader.querySelectorAll('img').length;
        countEl.textContent = `(${count}/${MAX_IMAGES})`;
      }

      addBtn.onclick = () => {
        const filled = uploader.querySelectorAll('img').length;
        if (filled >= MAX_IMAGES) {
          alert('الحد الأقصى 4 صور فقط');
          return;
        }
        // نضيف slot جديد فقط إذا لم يكن هناك slot فارغ بالفعل
        if (![...uploader.children].some(s => !s.querySelector('img'))) {
          uploader.appendChild(createSlot());
        }
      };

      clearBtn.onclick = () => {
        if (confirm('هل تريد حذف جميع الصور؟')) {
          localStorage.removeItem(STORAGE_KEY);
          loadImages();
        }
      };

      // تحديث حالة زر الإضافة عند تحميل الصفحة
      loadImages();

      // تصدير PDF
      exportBtn.onclick = async () => {
        if (!program.value.trim()) {
          alert('يرجى إدخال اسم البرنامج أولاً');
          program.focus();
          return;
        }

        exportBtn.disabled = true;
        exportBtn.textContent = 'جاري الإنشاء...';

        const { jsPDF } = window.jspdf;
        const temp = document.createElement('div');
        temp.style.cssText = 'position:fixed; left:-9999px; top:0; width:800px; padding:40px; background:#fff; font-family:"Tajawal",sans-serif; direction:rtl;';

        const heroBg = hero.style.backgroundImage;
        const heroUrl = heroBg && heroBg !== 'none' ? heroBg.slice(5, -2) : '';

        temp.innerHTML = `
          <div style="border:3px solid #006C35; border-radius:16px; padding:30px; min-height:1050px; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,0.1)">
            <div style="height:120px; background:linear-gradient(90deg,#0f7a46,#099169); border-radius:12px; margin-bottom:20px; overflow:hidden">
              ${heroUrl ? `<img src="${heroUrl}" style="width:100%; height:100%; object-fit:cover">` : ''}
            </div>
            <h1 style="text-align:center; color:#0b5c35; margin:0 0 30px; font-size:28px">تقرير برنامج </h1>
            
            <div style="font-size:18px; line-height:2">
              <p><strong>اسم البرنامج:</strong> ${program.value.trim()}</p>
              <p><strong>المنفذ:</strong> ${executor.value.trim() || 'غير محدد'}</p>
              <p><strong>المستهدفون:</strong> ${audience.value.trim() || 'غير محدد'}</p>
              <p><strong>عدد المستفيدين:</strong> ${beneficiaries.value.trim() || 'غير محدد'}</p>
              <p><strong>تاريخ التنفيذ:</strong> ${execdate.value || 'غير محدد'}</p>
              <p><strong>مكان التنفيذ:</strong> ${venue.value.trim() || 'غير محدد'}</p>
              <p><strong>مدير المدرسة:</strong> ${principal.value.trim() || 'غير محدد'}</p>
            </div>

            <h3 style="color:#0b5c35; border-bottom:2px solid #006C35; padding-bottom:8px; margin:30px 0 15px">الأهداف</h3>
            <ul style="line-height:2; font-size:17px; padding-right:20px">
              ${goals.value.trim() ? goals.value.trim().split('\n').filter(Boolean).map(g => `<li>${g.trim()}</li>`).join('') : '<li>لم يتم إدخال أهداف</li>'}
            </ul>

            <h3 style="color:#0b5c35; border-bottom:2px solid #006C35; padding-bottom:8px; margin:30px 0 15px">الشواهد المصورة</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
              ${[...uploader.querySelectorAll('img')].slice(0,4).map(img => 
                `<div style="border:1px solid #ddd; border-radius:8px; overflow:hidden">
                  <img src="${img.src}" style="width:100%; height:200px; object-fit:cover">
                </div>`
              ).join('')}
              ${Array(Math.max(0, 4 - uploader.querySelectorAll('img').length)).fill(
                `<div style="height:200px; background:#f8f9fa; border:2px dashed #dee2e6; border-radius:8px; display:grid; place-items:center; color:#adb5bd; font-size:14px">
                  لا توجد صورة
                </div>`
              ).join('')}
            </div>

            <div style="margin-top:50px; text-align:center; color:#666; font-size:14px; border-top:1px solid #eee; padding-top:15px">
              تصميم وتطوير: أ/ نفال النفيعي <br>
              التاريخ: ${new Date().toLocaleDateString('ar-SA')}
            </div>
          </div>
        `;

        document.body.appendChild(temp);

        try {
          const canvas = await html2canvas(temp.firstElementChild, { 
            scale: 2, 
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
          });
          const imgData = canvas.toDataURL('image/jpeg', 0.95);
          const pdf = new jsPDF('p', 'mm', 'a4');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          const imgHeight = (canvas.height * pdfWidth) / canvas.width;
          let heightLeft = imgHeight;

          let position = 0;
          pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
          heightLeft -= pdfHeight;

          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;
          }

          const safeName = (program.value.trim() || 'تقرير_مدرسي').replace(/[^ا-ي0-9]/g, '_');
          pdf.save(`${safeName}_${new Date().toISOString().slice(0,10)}.pdf`);
        } catch (e) {
          console.error(e);
          alert('حدث خطأ أثناء إنشاء الـ PDF، تأكد من رفع الصور من جهازك وليس روابط خارجية.');
        } finally {
          temp.remove();
          exportBtn.disabled = false;
          exportBtn.textContent = 'تصدير كـ PDF';
        }
      };
    });
  </script>
</body>

</html>
