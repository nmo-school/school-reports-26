<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>بوابة التقارير المدرسية</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f9f7; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#006C35; --line:#e0efe7; --accent:#009879; --radius:14px; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, Tahoma, Arial, sans-serif; background:var(--bg); color:var(--ink) }

    /* ======= واجهة الموقع ======= */
    header.site{ background:linear-gradient(180deg,#0f7a46 0%, #0a5b35 100%); color:#fff; position:relative }
    .hero{ inline-size:100%; block-size:clamp(120px, 16vw, 180px); background-position:center; background-repeat:no-repeat; background-size:cover }
    .page{ max-width:950px; margin:0 auto; padding:16px }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px }
    .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }
    label{ font-size:14px; color:var(--muted); display:block; margin-bottom:6px }
    input[type="text"],input[type="date"],textarea{ width:100%; border:1px solid var(--line); border-radius:12px; padding:10px 12px; font-size:16px; background:#fff; outline:none }
    textarea{ min-height:110px; resize:vertical }
    input:focus,textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(0,108,53,.12) }

    .uploader-ctrl{ margin-top:8px }
    .uploader{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
    .slot{ border:1px dashed var(--line); border-radius:12px; aspect-ratio:4/3; position:relative; overflow:hidden; background:#f4faf7; display:grid; place-items:center }
    .slot input{ position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer }
    .slot img{ width:100%; height:100%; object-fit:cover }
    .slot .remove{ position:absolute; top:6px; left:6px; background:#ef4444; color:#fff; border:none; border-radius:8px; padding:4px 8px; cursor:pointer; font-weight:800 }

    .bar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .btn{ appearance:none; border:1px solid var(--brand); background:var(--brand); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800 }
    .btn.outline{ background:#fff; color:var(--brand) }

    footer.site{ margin-top:12px; background:#0b3d28; color:#d7f5e4 }
    footer.site .wrap{ max-width:950px; margin:0 auto; padding:12px 16px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between }
    footer.site .item{ font-weight:800 }
  </style>
</head>
<body>
  <!-- ديباجة الموقع -->
  <header class="site">
    <div class="hero" id="site-hero"></div>
  </header>

  <!-- واجهة -->
  <main class="page">
    <section class="card">
      <h2 style="margin:0 0 10px;color:#064e2d">بيانات التقرير</h2>
      <div class="grid">
        <div><label>اسم البرنامج</label><input type="text" id="program"></div>
        <div><label>المنفذ</label><input type="text" id="executor"></div>
        <div><label>المستهدفون</label><input type="text" id="audience"></div>
        <div><label>عدد المستفيدين</label><input type="text" id="beneficiaries"></div>
        <div><label>تاريخ التنفيذ</label><input type="text" class="date"></div>
        <div><label>مكان التنفيذ</label><input type="text" id="venue"></div>
        <div style="grid-column:1/-1"><label>الأهداف</label><textarea id="goals"></textarea></div>
      </div>
      <div class="uploader-ctrl">
        <label>الشواهد — حد أقصى 4 صور <span id="w-count" class="muted">(0/4)</span></label>
        <div class="uploader" id="uploader"></div>
        <div class="bar">
          <button class="btn outline" id="addImage" type="button">إضافة صورة</button>
          <button class="btn outline" id="clearImages" type="button">حذف كل الصور</button>
          <button class="btn" id="exportPdfBtn" type="button">تصدير PDF</button>
        </div>
      </div>
      <div class="grid">
      <div><label>مدير المدرسة</label><input type="text" id="program"></div>
        </div>
    </section>
  </main>
  <!-- تذييل الموقع فقط -->
  <footer class="site">
    <center><div class="item">تصميم: أ/ نفال النفيعي</div></center>
    <div class="wrap"></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
  (function(){
    const ready = (fn)=>{
      if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', fn, {once:true}); }
      else{ fn(); }
    };

    ready(() => {
      const $=s=>document.querySelector(s);
      const program=$('#program'), executor=$('#executor'), audience=$('#audience'), beneficiaries=$('#beneficiaries'), execdate=$('#execdate'), venue=$('#venue'), goals=$('#goals');

      const splitGoals=txt=>txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);

      // ديباجة الواجهة
      (function initHero(){
        const hero=$('#site-hero');
        const qp = new URLSearchParams(location.search).get('dibajah');
        function setHero(url){ hero.style.backgroundImage = `url('${url}')`; window.__dibajahURL = url; }
        if(qp){ setHero(qp); }
        else{
          const exts=['webp','png','jpg','jpeg','svg'];
          (function tryNext(i){
            if(i>=exts.length) return; const src=`26.${exts[i]}`;
            const img=new Image(); img.onload=()=>setHero(src); img.onerror=()=>tryNext(i+1); img.src=src;
          })(0);
        }
      })();

      // شواهد
      const uploader=$('#uploader'); const countEl=$('#w-count'); const MAX=4;
      function makeSlot(src){
        const slot=document.createElement('div'); slot.className='slot';
        const input=document.createElement('input'); input.type='file'; input.accept='image/*';
        const img=document.createElement('img'); if(src) img.src=src;
        const rem=document.createElement('button'); rem.className='remove'; rem.textContent='حذف';
        rem.onclick=()=>{ slot.remove(); persist(); updateCount(); };
        input.onchange=e=>{
          const f=e.target.files[0]; if(!f) return;
          const r=new FileReader();
          r.onload=ev=>{ img.src=ev.target.result; if(!img.isConnected) slot.appendChild(img); persist(); updateCount(); };
          r.readAsDataURL(f);
        };
        slot.appendChild(rem); slot.appendChild(input); if(src) slot.appendChild(img);
        return slot;
      }
      function persist(){ const imgs=[...uploader.querySelectorAll('img')].map(i=>i.src); localStorage.setItem('witnesses', JSON.stringify(imgs.slice(0,MAX))); }
      function updateCount(){ const n=uploader.querySelectorAll('img').length; countEl.textContent = `(${n}/${MAX})`; }
      function load(){ const imgs=JSON.parse(localStorage.getItem('witnesses')||'[]'); uploader.innerHTML=''; if(imgs.length===0){ uploader.appendChild(makeSlot()); } imgs.slice(0,MAX).forEach(s=>uploader.appendChild(makeSlot(s))); updateCount(); }
      load();
      $('#addImage').addEventListener('click', ()=>{ const n=uploader.querySelectorAll('img').length; if(n>=MAX){ alert('الحد الأقصى 4 صور'); return; } uploader.appendChild(makeSlot()); });
      $('#clearImages').addEventListener('click', ()=>{ uploader.innerHTML=''; persist(); updateCount(); uploader.appendChild(makeSlot()); });

      function escapeHTML(s){return s.replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\\\"":"&quot;","'":"&#39;"}[m]))}

      // Helpers
      function waitForImages(el){
        const imgs = Array.from(el.querySelectorAll('img')).filter(im=>!im.complete || im.naturalWidth===0);
        if(imgs.length===0) return Promise.resolve();
        return Promise.all(imgs.map(im => new Promise(res => { im.onload = im.onerror = res; })));
      }
      async function toDataURLSafe(url){
        try{ const res = await fetch(url, {mode:'cors'}); if(!res.ok) throw new Error('fetch failed');
          const blob = await res.blob();
          return await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(blob); });
        }catch(e){ console.warn('toDataURLSafe failed for', url, e); return null; }
      }
      function getHeroURL(){
        if(window.__dibajahURL) return window.__dibajahURL;
        const hero = document.getElementById('site-hero');
        const bg = getComputedStyle(hero).backgroundImage;
        const m = bg && bg !== 'none' ? bg.match(/url\((\"|\\')?(.*?)(\1)\)/) : null;
        return m ? m[2] : null;
      }

      // بناء التقرير مؤقتًا وقت التصدير
      async function buildReportDOM(){
        const wrap=document.createElement('div');
        wrap.style.position='fixed';
        wrap.style.left='-99999px'; wrap.style.top='0'; wrap.style.width='740px'; wrap.style.background='#fff';
        wrap.setAttribute('aria-hidden','true');
        wrap.innerHTML = `
          <style>
            .report-wrapper{ width:740px; min-height:1040px; padding:22px; background:#fff; border:2px solid #006C35; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.06); font-family:'Tajawal', system-ui, sans-serif; color:#0f172a; }
            .report-banner{ height:100px; border-radius:10px; background:linear-gradient(90deg,#0f7a46,#099169); display:grid; place-items:center; margin-bottom:14px; overflow:hidden }
            .report-banner img{ max-height:100%; object-fit:contain; display:none }
            .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
            .grid-2{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px }
            .field{ border:2px solid #006C35; border-radius:10px; padding:10px; min-height:65px; background:#fbfffd; position:relative }
            .field .title{ position:absolute; top:-11px; inset-inline-start:12px; background:#fff; color:#0b5c35; padding:0 6px; font-weight:800; font-size:14px }
            .field .body{ padding-top:8px; line-height:1.7; min-height:40px }
            .section-title{ color:#0b5c35; margin:12px 0 6px; font-size:16px; font-weight:800 }
            .witnesses{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:6px }
            .witnesses figure{ margin:0; overflow:hidden; aspect-ratio:4/3; display:grid; place-items:center }
            .witnesses img{ width:100%; height:100%; object-fit:cover; border-radius:8px }
            .goals-wrap{ direction:rtl; text-align:right; }
            .goal-line{ display:block; margin:0 0 6px 0; }
          </style>
          <div class="report-wrapper">
            <div class="report-banner"><img id="reportHeader" alt="ديباجة المدرسة"></div>
            <div class="field"><div class="title">اسم البرنامج</div><div class="body" id="fProgram"></div></div>
            <div class="grid-3" style="margin-top:12px">
              <div class="field"><div class="title">المنفذ</div><div class="body" id="fExecutor"></div></div>
              <div class="field"><div class="title">المستهدفون</div><div class="body" id="fAudience"></div></div>
              <div class="field"><div class="title">عدد المستفيدين</div><div class="body" id="fBeneficiaries"></div></div>
            </div>
            <div class="grid-2" style="margin-top:12px">
              <div class="field"><div class="title">مكان التنفيذ</div><div class="body" id="fVenue"></div></div>
              <div class="field"><div class="title">تاريخ التنفيذ</div><div class="body" id="fExecdate"></div></div>
            </div>
            <div class="section-title">الأهداف</div>
            <div class="field" style="min-height:120px"><div class="body goals-wrap" id="fGoals"></div></div>
            <div class="section-title">الشواهد</div>
            <div class="witnesses" id="vWitnesses"><figure></figure><figure></figure><figure></figure><figure></figure></div>
          </div>`;

        // تعبئة نصوص
        wrap.querySelector('#fProgram').textContent = (program.value||'').trim();
        wrap.querySelector('#fExecutor').textContent = (executor.value||'').trim();
        wrap.querySelector('#fAudience').textContent = (audience.value||'').trim();
        wrap.querySelector('#fBeneficiaries').textContent = (beneficiaries.value||'').trim();
        wrap.querySelector('#fVenue').textContent = (venue.value||'').trim();
        wrap.querySelector('#fExecdate').textContent = (execdate.value||'').trim();
        const lines=splitGoals(goals.value||'');
        wrap.querySelector('#fGoals').innerHTML = lines.length ? lines.map(x=>`<span class="goal-line">${escapeHTML(x)}</span>`).join('') : "";

        // ديباجة التقرير: نحاول تحويل صورة الواجهة لبيانات محلية؛ لو ما نقدر، نكمل بدون ما نوقف
        const rep=wrap.querySelector('#reportHeader');
        const heroURL = getHeroURL();
        if(heroURL){
          const dataUrl = await toDataURLSafe(heroURL);
          if(dataUrl){ rep.src = dataUrl; rep.style.display='block'; }
        }

        document.body.appendChild(wrap);
        return wrap;
      }

      async function exportPDF(){
        // كشف jsPDF في جميع الأشكال
        const jspdfNS = window.jspdf || window.jsPDF || null;
        const jsPDFCtor = jspdfNS && (jspdfNS.jsPDF || jspdfNS);
        if(!window.html2canvas || !jsPDFCtor){
          console.error('المكتبات غير محمّلة');
          alert('تعذّر التصدير: مكتبات التصدير غير محمّلة.');
          return;
        }

        // محاولة التصدير الكامل
        let usedFallback = false;
        let temp = null;
        try{
          temp = await buildReportDOM();
          const report = temp.querySelector('.report-wrapper');

          // صور الشواهد
          const grid=temp.querySelector('#vWitnesses');
          const currentImgs=[...uploader.querySelectorAll('img')].slice(0,4).map(n=>n.src);
          grid.innerHTML='';
          for(let i=0;i<4;i++){const fig=document.createElement('figure'); if(currentImgs[i]){const im=document.createElement('img'); im.src=currentImgs[i]; fig.appendChild(im);} grid.appendChild(fig);}

          try{ await waitForImages(report); }catch(_){}

          const canvas=await html2canvas(report,{scale:2,useCORS:true,background:'#fff'});
          const img=canvas.toDataURL('image/jpeg',0.95);
          const pdf=new jsPDFCtor('p','mm','a4');
          const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
          const imgW=pageW, imgH=(canvas.height*imgW)/canvas.width;
          pdf.addImage(img,'JPEG',0,0,imgW,imgH,'','FAST');
          let heightLeft=imgH-pageH, pos=-pageH;
          while(heightLeft>0){ pdf.addPage(); pdf.addImage(img,'JPEG',0,pos,imgW,imgH,'','FAST'); heightLeft-=pageH; pos-=pageH; }
          pdf.save('school-26-report.pdf');
        }catch(err){
          console.error('full render failed, using fallback', err);
          usedFallback = true;
        }finally{
          if(temp) temp.remove();
        }

        // Fallback: PDF نصي بسيط من الحقول (حتى لا يطلع الزر “ما يسوي شيء”)
        if(usedFallback){
          try{
            const pdf=new (window.jspdf ? window.jspdf.jsPDF : window.jsPDF)('p','mm','a4');
            let y=20;
            pdf.setFont('helvetica','bold'); pdf.text('تقرير البرنامج', 105, y, {align:'center'}); y+=10;
            pdf.setFont('helvetica','normal');
            const rows=[
              ['اسم البرنامج', program.value],
              ['المنفذ', executor.value],
              ['المستهدفون', audience.value],
              ['عدد المستفيدين', beneficiaries.value],
              ['مكان التنفيذ', venue.value],
              ['تاريخ التنفيذ', execdate.value],
            ];
            rows.forEach(([k,v])=>{ pdf.text(`${k}: ${v||''}`, 195, y, {align:'right'}); y+=8; });
            const goalsText = (goals.value||'').split(/\n+/).filter(Boolean);
            if(goalsText.length){ y+=4; pdf.setFont('helvetica','bold'); pdf.text('الأهداف:', 195, y, {align:'right'}); y+=8; pdf.setFont('helvetica','normal'); goalsText.forEach(g=>{ pdf.text(`- ${g}`, 190, y, {align:'right', maxWidth:170}); y+=8; if(y>280){ pdf.addPage(); y=20; } }); }
            pdf.save('school-26-report.pdf');
          }catch(e){ alert('تعذّر التصدير. جرّبي تحديث الصفحة أو استخدام متصفح مختلف.'); }
        }
      }

      // اربط الزر بشكل موثوق
      const bind = () => {
        const btn = document.getElementById('exportPdfBtn');
        if(btn){ btn.onclick = () => { exportPDF().catch(console.error); }; }
      };
      bind();
      const mo = new MutationObserver(bind); mo.observe(document.body, {childList:true, subtree:true});
    });
  })();
  </script>
</body>
</html>
